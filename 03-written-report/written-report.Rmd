---
title: "Your project title"
author: 'Last!: Parker Dingman, Ethan Donecoff, Karam Oubari, Pei Yi Zhuo'
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```

```{r load-packages-data}
library(tidyverse)
library(here)
library(rms)
life <- read_csv(here("data", "life_expectancy.csv"))
regions <- read_csv(here("data", "regions.csv"))
```

```{r add-region, results = "hide"}
regions <- regions %>%
  select(Country, Region) %>%
  mutate(Country = gsub("&", "and", Country))
initial_join <- life %>%
  left_join(regions, by = "Country") %>%
  select(Country, Region, Year:Schooling)
(na_countries <- initial_join %>%
  select(Country, Region) %>%
  distinct() %>%
  filter(is.na(Region)) %>%
  select(Country) %>%
  pull())
# Montenegro, Niue, and South Sudan do not appear in 'regions'.
# Alternate names of Cabo Verde, Czechia, and 
# Timor-Leste were obtained through Google.
regions <- regions %>%
  mutate(
    Country = case_when(
      Country == "Bahamas, The" ~ "Bahamas",
      Country == "Bolivia" ~ "Bolivia (Plurinational State of)",
      Country == "Brunei" ~ "Brunei Darussalam",
      Country == "Cote d'Ivoire" ~ "CÃ´te d'Ivoire",
      Country == "Cape Verde" ~ "Cabo Verde",
      Country == "Central African Rep." ~ "Central African Republic",
      Country == "Congo, Repub. of the" ~ "Congo",
      Country == "Czech Republic" ~ "Czechia",
      Country == "Korea, North" ~ "Democratic People's Republic of Korea",
      Country == "Congo, Dem. Rep." ~ "Democratic Republic of the Congo",
      Country == "Gambia, The" ~ "Gambia",
      Country == "Iran" ~ "Iran (Islamic Republic of)",
      Country == "Laos" ~ "Lao People's Democratic Republic",
      Country == "Micronesia, Fed. St." ~ "Micronesia (Federated States of)",
      Country == "Burma" ~ "Myanmar",
      Country == "Korea, South" ~ "Republic of Korea",
      Country == "Moldova" ~ "Republic of Moldova",
      Country == "Russia" ~ "Russian Federation",
      Country == "Syria" ~ "Syrian Arab Republic",
      Country == "Macedonia" ~ "The former Yugoslav republic of Macedonia",
      Country == "East Timor" ~ "Timor-Leste",
      Country == "United Kingdom" ~ 
        "United Kingdom of Great Britain and Northern Ireland",
      Country == "Tanzania" ~ "United Republic of Tanzania",
      Country == "United States" ~ "United States of America",
      Country == "Venezuela" ~ "Venezuela (Bolivarian Republic of)",
      Country == "Vietnam" ~ "Viet Nam",
      TRUE ~ Country
    )
  )
life <- life %>%
  left_join(regions, by = "Country") %>%
  select(Country, Region, Year:Schooling)
# The regions of Montenegro, Niue, and South Sudan 
# were identified/confirmed through Google.
life$Region[life$Country == "Montenegro"] <- "EASTERN EUROPE"
# https://en.wikipedia.org/wiki/Category:Countries_in_Oceania
life$Region[life$Country == "Niue"] <- "OCEANIA"
life$Region[life$Country == "South Sudan"] <- "SUB-SAHARAN AFRICA"
rm(initial_join)
rm(na_countries)
rm(regions)
```

```{r filter-year, results = "hide"}
na_prop <- function(x) {
  x %>%
    is.na() %>%
    sum() %>%
    prod(1 / n()) 
}
years <- rep(list(NA), 16)
for(year in 2000:2015) {
  temp <- life %>%
    filter(Year == year) %>%
    summarise(across(everything(), na_prop)) %>%
    pivot_longer(cols = everything(),
                 names_to = "variable",
                 values_to = "na_prop") %>%
    pull(na_prop)
  names(temp) <- names(life)
  years[[year - 1999]] <- temp
}
names(years) <- 2000:2015
# 2011 is the latest year where no variable 
# has a missing rate greater than 0.22.
map_dbl(years, ~ any(`>`(., 0.22)))
# All the years where no variable has a missing rate greater 
# than 0.22 has a 'population' missing rate of 0.2185792.
map(years, ~ .[`>`(., 0.20)])
life <- filter(life, Year == 2011)
# Remove unnecessary objects
rm(na_prop)
rm(years)
rm(year)
rm(temp)
```

Your written report goes here! Before you submit, make sure your code chunks are turned off with `echo = FALSE` and there are no warnings or messages with `warning = FALSE` and `message = FALSE` 

## Introduction and Data

By telling us the average age of death in a population, life expectancy is a key metric for understanding a country's health. According to Max Roser, Esteban Ortiz-Ospina and Hannah Ritchie from Our World in Data, "Broader than the narrow metric of the infant and child mortality, which focus solely at mortality at a young age, life expectancy captures the mortality along the entire life course."[1] Over the course of history, life expectancy has risen dramatically. It is estimated that in pre-modern times, life expectancy worldwide was only about 30 years. Since the Industrial Revolution in the 18th and 19th centuries, many countries had huge gains in this number. And since the beginning of the 20th century, global average life expectancy has risen to about 70 years. However, there remain huge inequalities in this number. Currently (as of 2019), the Central African Republic has the lowest life expectancy of 53 years while Japan has the highest with 83.

In addition to the more obvious health-related connections to life expectancy, numerous pieces of academic literature have delved into the non-medical factors behind life expectancy. A major example is a longitudinal study conducted by Charles Lin, Eugene Rogot, Norman Johnson, Paul Sorlie, and Elizabeth Arias, which examined life expectancy by socioeconomic factors.[2] Academic literature such as this provides us with motivations to examine this topic on an international level, looking at various health-related and non-health-related factors that connect to life expectancy.

In terms of initial hypotheses of model selection, we expect that the strongest predictors of life expectancy will be `Adult Mortality`, `infant deaths`, and `GDP`. We also predict that countries that have `status` equal to "Developed" will have higher life expectancy than those that have `status` equal to "Developing".

Our primary data set is comprised of information that had been gleaned from the websites of the World Health Organization and the United Nations.[3] Each entry describes the health, social, and economic conditions for one of 193 countries in a given year from 2000 to 2015.[3] Because this data set lacks a variable that specifies the region of each country, we joined it with another data set that pairs country and region.[4]

\newpage

## Exploratory Data Analysis

First, we will look at some summary statistics of our response variable, `Life expectancy`.
Though it is possible to analyze the entire data set over all years, this creates difficulties 
with creating models. As one might expect, the average global life expectancy increased from
2000 to 2015. This relationship might make it unclear whether a rise in life expectancy is explained
by our predictor variables or if it is simply due to human development over time. As a result, we 
will only use data from one year to perform our analysis.

We will only analyze life expectancy for the year 2011, because it is the latest year among those years in which no variable has a missing rate greater than 22%.

```{r summary-stats1, warning = FALSE}
life %>%
  filter(!is.na(`Life expectancy`)) %>%
  summarise(min = min(`Life expectancy`), 
            max = max(`Life expectancy`),
            range = max - min,
            mean = mean(`Life expectancy`), 
            median = median(`Life expectancy`), 
            Q1 = quantile(`Life expectancy`, .25), 
            Q3 = quantile(`Life expectancy`, .75), 
            iqr = IQR(`Life expectancy`), 
            sd = sd(`Life expectancy`)) %>%
  kable(digits = 3, caption = "Summary Statistics of Response Variable, Life Expectancy")
```

These summary statistics give a rough idea of the distribution of the response variable.
The median life expectancy (~73.3 yrs) is almost 3 years larger than the mean (~70.7 yrs).
Additionally, the median is closer to the third quartile than the first quartile. 
This suggests that life expectancy may be left-skewed, which we will evaluate further 
with visualizations.

Now, we will look at some summary visualizations of life expectancy.

```{r summary-viz}
p1 <- ggplot(data = life, mapping = aes(x = `Life expectancy`)) + 
  geom_histogram() + 
  labs(title = "Distribution of Life Expectancy",
       subtitle = "2011",
       x = "Life Expectancy (Years)",
       y = "Count")
p2 <- ggplot(data = life, mapping = aes(x = `Life expectancy`)) + 
  geom_density() + 
  labs(title = "Distribution of Life Expectancy",
       subtitle = "2011",
       x = "Life Expectancy (Years)",
       y = "Proportion")
p3 <- ggplot(data = life, mapping = aes(x = `Life expectancy`, y = "")) + 
  geom_boxplot() + 
  labs(title = "Distribution of Life Expectancy",
       subtitle = "2011",
       x = "Life Expectancy (Years)",
       y = "")
(p1 + p2) / p3
```

Here we see that life expectancy is left skewed with a center just over 70 years.
Life expectancy ranges from about 50 years to 90 years. 

```{r world map}
library(ggplot2)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)

world <- ne_countries(scale = "medium", returnclass = "sf")

map_data <- life %>%
  mutate(Country = case_when(
         Country == "United States of America" ~ "USA", 
         Country == "Russian Federation" ~ "Russia", 
         TRUE ~ Country)) %>%
  select(Country, `Life expectancy`)

map <- map_data("world")

life_map <- left_join(map, map_data, by = c("region" = "Country"))

ggplot(data = life_map, mapping = aes(long, lat, group = group)) +
  coord_fixed(1) +
  geom_polygon(
    # color = "black",
    aes(fill = as.numeric(`Life expectancy`))
  ) +
  scale_fill_gradient(low = "red", high = "green", 
                      name = "2011 Life Expectancy in Years") +
  labs(title = "2011 Life Expectancy Across The World", 
       x = "Longitude", y = "Latitude")

#https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html
```

Here we can see the differences in life expectancy across the world. For example, it is clear that life expectancy is much higher in North and South American countries when compared to African countries.

\newpage

## Methodology

### Model Selection

In this project we plan on using various regression analysis methods including, but not limited to, multiple linear regression, statistical inference, analysis of variance, and model selection in an attempt to understand country and region-level life expectancy, as well as the health, social, and economic relationships behind this number. 

The response variable we will be using in this project is `Life expectancy`. This is a measure of the average age of death in a year for the given country during that year. In terms of regression model technique, we will be using multiple linear regression because our response variable is quantitative.

The goal of our analysis is to calculate the most precise prediction of the response variable (life expectancy). To do this we will perform forward and backward selection using AIC and BIC. Forward selection entails adding variables recursively using AIC or BIC as the criteria while backward selection means dropping variables one at a time that are deemed irrelevant based on AIC or BIC.

```{r full-model, results = "hide"}
life <- life %>%
  drop_na()
full_model <- lm(`Life expectancy` ~ Region + Status + `Adult Mortality` + 
                   `infant deaths` + Alcohol + `percentage expenditure` + 
                   `Hepatitis B` + Measles + BMI + `under-five deaths` + 
                   Polio + `Total expenditure` + Diphtheria + `HIV/AIDS` + 
                   GDP + Population + `thinness  1-19 years` + 
                   `thinness 5-9 years` + `Income composition of resources` + 
                   Schooling, data = life)
tidy(full_model) %>%
  kable(caption = "Full Model With All Possible Predictor Variables", 
        digits = 3)
```

```{r model-selection, results = "hide"}
# Backward selection
backward_aic <- step(full_model, direction = "backward")
backward_bic <- step(full_model, direction = "backward", k = log(nrow(life)))
# Forward selection
int_model <- lm(`Life expectancy` ~ 1, data = life)
forward_aic <- step(int_model, formula(full_model), direction = "forward")
forward_bic <- step(int_model, formula(full_model), 
                    direction = "forward", k = log(nrow(life)))
```

```{r disp-models, results = "hide"}
tidy(backward_aic) %>%
  kable(caption = "Backward Model Selection with AIC", digits = 3)
tidy(backward_bic) %>%
  kable(caption = "Backward Model Selection with BIC", digits = 3)
tidy(forward_aic) %>%
  kable(caption = "Forward Model Selection with AIC", digits = 3)
tidy(forward_bic) %>%
  kable(caption = "Forward Model Selection with BIC", digits = 3)
```

```{r model-comparison}
models <- list(backward_aic, backward_bic, 
               forward_aic, forward_bic)
methods <- c("Backward (AIC)", "Backward (BIC)",
             "Forward (AIC)", "Forward (BIC)")

out <- tibble(
  `Selection Method` = NA,
  `AIC` = NA,
  `BIC` = NA,
  `Adjusted R-squared` = NA
)
for(i in 1:length(models)) {
  temp <- models[[i]] %>%
    glance() %>%
    select(AIC, BIC, `Adjusted R-squared` = adj.r.squared) %>%
    mutate(`Selection Method` = methods[[i]])
  out <- rbind(out, temp)
}

kable(out[-1, ], caption = "Potential models", digits = 3)

# glance(backward_aic) %>% 
#   select(AIC, BIC, adj.r.squared) #this will become the selected model
# glance(backward_bic) %>% 
#   select(AIC, BIC, adj.r.squared) 
# glance(forward_aic) %>% 
#   select(AIC, BIC, adj.r.squared)
# glance(forward_bic) %>% 
#   select(AIC, BIC, adj.r.squared)
selected_model <- backward_aic
```

Based on AIC and adjusted $R^2$, we prefer the model we found through backward selection using AIC. This model results in the highest adjusted $R^2$ which means that the model's predictor variables explain the highest proportion of the variation in the response (`Life expectancy`) out of all four models. Moreover, this model is the only model of the four that is superior to the other models in more than one metric. 

```{r r-sq, results = "hide"}
glance(selected_model) %>% select(r.squared)
```

```{r selected-model}
kable(tidy(selected_model),
      caption = "Selected Model",
      digits = 3)
```

93.03% of the variation in the `Life expectancy` is explained by the regression model above, which contains `Region`, `Adult Mortality`, `infant deaths`, `Hepatitis B`, `Measles`, `under-five deaths`, `Total expenditure`, `Diphtheria`, `HIV/AIDS`, `Income composition of resources` and `Schooling`.

### Model Diagnostics

```{r augment}
selected_model_aug <- augment(selected_model)
selected_model_aug <- selected_model_aug %>%
  mutate(obs_num = 1:nrow(selected_model_aug))
```

```{r}
ggplot(data = selected_model_aug, aes(x = .fitted, y = .std.resid)) +
  geom_point(alpha = 0.7) + 
  geom_hline(yintercept = 0, color = "red") +
  geom_hline(yintercept = -2,color = "black",linetype = "dotted") +
  geom_hline(yintercept = 2,color = "black",linetype = "dotted") +
  geom_hline(yintercept = -3, color = "red", linetype = "dotted") +
  geom_hline(yintercept = 3, color = "red", linetype = "dotted") +
  labs(x = "Predicted", y = "Standardized Residuals",
       title = "Standardized Residuals vs. Predicted")
```
There are a few moderate outliers and two severe outliers. Will look into these later.

```{r threshold}
# (2(p+1))/n
leverage_threshold <- 2 * (20 + 1) / nrow(selected_model_aug)
leverage_threshold
```
0.3230769 is the leverage threshold.



```{r high-leverage-influencial}
selected_model_aug %>%
  filter(.hat > leverage_threshold) %>%
  select(obs_num, .hat) 
selected_model_aug %>%
  filter(.cooksd > .5) %>%
  select(obs_num, .cooksd) 
```
The points in the first table are points with high leverage (.hat > leverage_threshold = 0.3230769) while the points in the second table are influential points (.cooksd > 0.5). 15 observations have high leverage and 0 observations are influential.


```{r multicollinearity}
vif(selected_model) %>% 
  tidy() %>% 
  kable(digits = 3)
ggplot(data = life, aes(x = Schooling, 
                        y = `Income composition of resources`)) +
  geom_point()
```
Variables with a VIF > 10 will have issues with multicollinearity. `infant deaths` and `under-five deaths` are clearly highly correlated (this makes a lot of sense in the context of the data). `Income composition of resources` appears to be correlated with `Schooling`.

We should try models without either `infant deaths` and `under-five deaths` and then use model comparison techniques to decide on which of these two variables should be removed.

```{r infant-five}
ex_inf <- lm(`Life expectancy` ~ Region + `Adult Mortality` +
               `Hepatitis B` + `Measles` + `under-five deaths` +
               `Total expenditure` + `Diphtheria` + `HIV/AIDS` +
               `Income composition of resources` + `Schooling`,
             data = life)
ex_five <- lm(`Life expectancy` ~ Region + `Adult Mortality` +
                `infant deaths` + `Hepatitis B` + `Measles` + 
                `Total expenditure` + `Diphtheria` + `HIV/AIDS` +
                `Income composition of resources` + `Schooling`,
             data = life)
ex_inf %>%
  glance() %>%
  select(AIC, BIC, adj.r.squared)
ex_five %>%
  glance() %>%
  select(AIC, BIC, adj.r.squared)
```

```{r income-schooling}
ex_inc <- lm(`Life expectancy` ~ Region + `Adult Mortality` +
               `infant deaths` + `Hepatitis B` + `Measles` + 
               `Total expenditure` + `Diphtheria` + `HIV/AIDS` + 
               `Schooling`,
             data = life)
ex_sch <- lm(`Life expectancy` ~ Region + `Adult Mortality` +
               `infant deaths` + `Hepatitis B` + `Measles` + 
               `Total expenditure` + `Diphtheria` + `HIV/AIDS` +
               `Income composition of resources`,
             data = life)
ex_inc %>%
  glance() %>%
  select(AIC, BIC, adj.r.squared)
ex_sch %>%
  glance() %>%
  select(AIC, BIC, adj.r.squared)
final_model <- ex_sch
```

When comparing two models that are identical except that one includes `under-five deaths` and the other includes `infant deaths`, the one that includes `infant deaths` has lower values of AIC and BIC as well as a higher value of adjusted $R^2$. Likewise, given two models that have the same predictors except that one includes `Schooling` while the other includes `Income composition of resources`, the one that includes `Income composition of resources` is superior in terms of AIC, BIC, and adjusted $R^2$.

### Model Conditions/Assumptions

```{r normality-viz}
(resid_hist <- final_model %>%
  augment() %>%
  ggplot(aes(x = .std.resid)) +
  geom_histogram() +
  labs(title = "Distribution of Residuals",
       subtitle = "Final Model",
       x = "Residual",
       y = "Count"))
```

## Results

## Sources

[1] https://ourworldindata.org/life-expectancy \newline
[2] https://europepmc.org/article/med/12785422/reload=0#impact \newline
[3] https://www.kaggle.com/kumarajarshi/life-expectancy-who. \newline
[4] https://www.kaggle.com/fernandol/countries-of-the-world
